<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Manager</title>
    <style>
:root {
  --bg-primary: #0f1419;
  --bg-secondary: #1a2332;
  --bg-tertiary: #243044;
  --bg-card: #1e2a3a;
  --text-primary: #e7edf4;
  --text-secondary: #8899a6;
  --text-muted: #5c6e7e;
  --accent-blue: #1d9bf0;
  --accent-green: #00ba7c;
  --accent-orange: #ff7a00;
  --accent-red: #f4212e;
  --accent-purple: #7856ff;
  --accent-yellow: #ffd400;
  --border-color: #2f3b4a;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  --radius: 8px;
  --radius-sm: 4px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.5;
}
/* Header */
.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.logo {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-blue);
    display: flex;
    align-items: center;
    gap: 8px;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.project-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.project-selector select {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    cursor: pointer;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-secondary);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
}

.status-dot.connected {
    background: var(--accent-green);
    box-shadow: 0 0 8px var(--accent-green);
}

.user-name {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 13px;
}

/* Main Layout */
.main-container {
    display: flex;
    height: calc(100vh - 57px);
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
}

/* Content Area */
.content {
    flex: 1;
    overflow: auto;
    padding: 20px;
}

/* Toolbar */
.toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
}
/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--accent-blue);
    color: white;
}

.btn-primary:hover {
    background: #1a8cd8;
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-card);
}

.btn-icon {
    padding: 8px;
    background: transparent;
    color: var(--text-secondary);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
}

.btn-icon:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.btn-small {
    padding: 4px 8px;
    font-size: 12px;
}
/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow: auto;
    box-shadow: var(--shadow);
    transform: translateY(-20px);
    transition: transform 0.2s;
}

.modal-overlay.show .modal {
    transform: translateY(0);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
}

.modal-close:hover {
    color: var(--text-primary);
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-color);
}

/* Form */
.form-group {
    margin-bottom: 16px;
}

.form-label {
    display: block;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.form-label.required::after {
    content: ' *';
    color: var(--accent-red);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: inherit;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--accent-blue);
}

.form-textarea {
    min-height: 80px;
    resize: vertical;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-checkbox input {
    width: 18px;
    height: 18px;
    cursor: pointer;
}
/* WBS Tree */
.wbs-tree {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    overflow: hidden;
}

.wbs-header {
    display: grid;
    grid-template-columns: minmax(300px, 1fr) 100px 80px 120px 100px 80px 60px;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-tertiary);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
}

.wbs-list {
    max-height: calc(100vh - 280px);
    overflow-y: auto;
}

.wbs-item {
    display: grid;
    grid-template-columns: minmax(300px, 1fr) 100px 80px 120px 100px 80px 60px;
    gap: 8px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    align-items: center;
    transition: background 0.15s;
}

.wbs-item:hover {
    background: var(--bg-card);
}

.wbs-item.selected {
    background: rgba(29, 155, 240, 0.1);
    border-left: 3px solid var(--accent-blue);
}

.wbs-item.level-0 {
    font-weight: 600;
}

.wbs-item.level-1 .wbs-name {
    padding-left: 24px;
}

.wbs-item.level-2 .wbs-name {
    padding-left: 48px;
}

.wbs-item.level-3 .wbs-name {
    padding-left: 72px;
}

.wbs-name {
    display: flex;
    align-items: center;
    gap: 8px;
}

.wbs-toggle {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-secondary);
    border-radius: 4px;
}

.wbs-toggle:hover {
    background: var(--bg-tertiary);
}

.wbs-type-badge {
    width: 4px;
    height: 24px;
    border-radius: 2px;
    flex-shrink: 0;
}

.wbs-type-badge.deliverable {
    background: var(--accent-blue);
}

.wbs-type-badge.support {
    background: var(--accent-orange);
}

.wbs-type-badge.buffer {
    background: var(--accent-purple);
}

.wbs-code {
    color: var(--text-secondary);
    font-size: 12px;
    font-family: 'Consolas', monospace;
    min-width: 40px;
}

.wbs-title {
    flex: 1;
    cursor: pointer;
}

.wbs-title:hover {
    color: var(--accent-blue);
}

.milestone-icon {
    color: var(--accent-yellow);
}

.wbs-assignee {
    font-size: 13px;
    color: var(--text-secondary);
}

.wbs-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 10px;
    text-align: center;
}

.wbs-status.not-started {
    background: rgba(92, 110, 126, 0.2);
    color: var(--text-secondary);
}

.wbs-status.in-progress {
    background: rgba(29, 155, 240, 0.2);
    color: var(--accent-blue);
}

.wbs-status.completed {
    background: rgba(0, 186, 124, 0.2);
    color: var(--accent-green);
}

.wbs-status.on-hold {
    background: rgba(255, 122, 0, 0.2);
    color: var(--accent-orange);
}

.wbs-dates {
    font-size: 12px;
    color: var(--text-secondary);
}

.wbs-dates.overdue {
    color: var(--accent-red);
}

/* Progress Bar */
.progress-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.progress-bar {
    flex: 1;
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--accent-green);
    border-radius: 3px;
    transition: width 0.3s;
}

.progress-text {
    font-size: 12px;
    color: var(--text-secondary);
    min-width: 35px;
    text-align: right;
}

/* Dependencies */
.wbs-deps {
    font-size: 11px;
    color: var(--text-muted);
}

.dep-badge {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 4px;
}

/* Actions */
.wbs-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s;
}

.wbs-item:hover .wbs-actions {
    opacity: 1;
}
/* Gantt Chart */
.gantt-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    overflow: hidden;
}

.gantt-header {
    display: flex;
    border-bottom: 1px solid var(--border-color);
}

.gantt-labels {
    width: 250px;
    flex-shrink: 0;
    background: var(--bg-tertiary);
}

.gantt-timeline {
    flex: 1;
    overflow-x: auto;
}

.gantt-dates {
    display: flex;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
}

.gantt-date {
    min-width: 40px;
    padding: 8px 4px;
    text-align: center;
    font-size: 10px;
    color: var(--text-secondary);
    border-right: 1px solid var(--border-color);
}

.gantt-date.weekend {
    background: rgba(0, 0, 0, 0.2);
}

.gantt-date.today {
    background: rgba(29, 155, 240, 0.2);
    color: var(--accent-blue);
}

.gantt-rows {
    display: flex;
}

.gantt-row-labels {
    width: 250px;
    flex-shrink: 0;
}

.gantt-row-label {
    height: 36px;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-color);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    gap: 8px;
}

.gantt-row-bars {
    flex: 1;
}

.gantt-row {
    height: 36px;
    position: relative;
    border-bottom: 1px solid var(--border-color);
}

.gantt-bar {
    position: absolute;
    top: 6px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    padding: 0 8px;
    font-size: 11px;
    color: white;
    cursor: pointer;
    transition: filter 0.15s;
}

.gantt-bar:hover {
    filter: brightness(1.1);
}

.gantt-bar.deliverable {
    background: var(--accent-blue);
}

.gantt-bar.support {
    background: var(--accent-orange);
}

.gantt-bar.buffer {
    background: var(--accent-purple);
}

.gantt-bar .progress-overlay {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px 0 0 4px;
}

.gantt-milestone {
    position: absolute;
    top: 10px;
    width: 16px;
    height: 16px;
    background: var(--accent-yellow);
    transform: rotate(45deg);
    cursor: pointer;
}

.gantt-dependency-line {
    position: absolute;
    pointer-events: none;
}
/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.empty-state-title {
    font-size: 18px;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.empty-state-desc {
    font-size: 14px;
    margin-bottom: 20px;
}

/* Context Menu */
.context-menu {
    position: fixed;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow);
    min-width: 160px;
    z-index: 1001;
    display: none;
}

.context-menu.show {
    display: block;
}

.context-menu-item {
    padding: 10px 16px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

.context-menu-item:hover {
    background: var(--bg-tertiary);
}

.context-menu-item.danger {
    color: var(--accent-red);
}

.context-menu-divider {
    height: 1px;
    background: var(--border-color);
    margin: 4px 0;
}

/* Toast */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1002;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.toast {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    animation: slideIn 0.3s ease;
}

.toast.success {
    border-left: 3px solid var(--accent-green);
}

.toast.error {
    border-left: 3px solid var(--accent-red);
}

.toast.info {
    border-left: 3px solid var(--accent-blue);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }

    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Initial Setup */
.setup-container {
    max-width: 500px;
    margin: 100px auto;
    padding: 40px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    text-align: center;
}

.setup-icon {
    font-size: 48px;
    margin-bottom: 20px;
}

.setup-title {
    font-size: 24px;
    margin-bottom: 8px;
}

.setup-desc {
    color: var(--text-secondary);
    margin-bottom: 24px;
}

.setup-steps {
    text-align: left;
    margin-bottom: 24px;
    padding: 16px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
}

.setup-step {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    font-size: 14px;
}

.setup-step:last-child {
    margin-bottom: 0;
}

.setup-step-num {
    width: 24px;
    height: 24px;
    background: var(--accent-blue);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
}

/* Sidebar Widgets Addon */
.view-tabs {
    display: flex;
    padding: 12px 16px;
    gap: 4px;
    border-bottom: 1px solid var(--border-color);
}

.view-tab {
    flex: 1;
    padding: 8px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 12px;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: all 0.2s;
}

.view-tab:hover {
    background: var(--bg-tertiary);
}

.view-tab.active {
    background: var(--accent-blue);
    color: white;
}

.legend {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
}

.legend-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.legend-items {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-secondary);
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}

.legend-color.deliverable {
    background: var(--accent-blue);
}

.legend-color.support {
    background: var(--accent-orange);
}

.legend-color.buffer {
    background: var(--accent-purple);
}

.legend-color.milestone {
    background: var(--accent-yellow);
}

.summary-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.summary-card {
    background: var(--bg-tertiary);
    padding: 12px;
    border-radius: var(--radius-sm);
}

.summary-card .value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.summary-card .label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 2px;
}

.summary-card.progress .value {
    color: var(--accent-green);
}

.summary-card.delayed .value {
    color: var(--accent-red);
}

</style>
</head>

<body>
    <!-- Initial Setup Screen -->
    <div id="setupScreen" class="setup-container">
        <div class="setup-icon">ğŸ“Š</div>
        <h1 class="setup-title">WBS Manager</h1>
        <p class="setup-desc">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®WBSç®¡ç†ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>

        <div class="setup-steps">
            <div class="setup-step">
                <span class="setup-step-num">1</span>
                <span>å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€å†…ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</span>
            </div>
            <div class="setup-step">
                <span class="setup-step-num">2</span>
                <span>ä¸‹ã®ãƒœã‚¿ãƒ³ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</span>
            </div>
            <div class="setup-step">
                <span class="setup-step-num">3</span>
                <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
            </div>
        </div>

        <div class="form-group" style="margin-bottom: 16px; text-align: left;">
            <label class="form-label required">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
            <input type="text" id="setupUserName" class="form-input" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
        </div>

        <button class="btn btn-primary" onclick="window.app.selectProjectFolder()" style="width: 100%;">
            ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã
        </button>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon">ğŸ“Š</div>
                    WBS Manager
                </div>
                <div class="project-selector">
                    <select id="projectSelect" onchange="window.app.switchProject()">
                        <option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="window.app.showNewProjectModal()">+ æ–°è¦</button>
                </div>
            </div>
            <div class="header-right">
                <div class="connection-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">æœªæ¥ç¶š</span>
                </div>
                <button class="btn-icon" onclick="window.app.reloadData()" title="å†èª­ã¿è¾¼ã¿">ğŸ”„</button>
                <button class="btn btn-secondary btn-small" onclick="window.app.showCategoryModal()">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>
                <button class="btn btn-secondary btn-small" onclick="window.app.showMemberModal()">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
                <button class="btn btn-secondary btn-small" onclick="window.app.showMilestoneModal()">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†</button>
                <input type="text" class="user-name" id="userName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
                    onchange="window.app.saveUserName()">
                <button class="btn btn-secondary btn-small" onclick="window.app.selectProjectFolder()">ğŸ“
                    ãƒ•ã‚©ãƒ«ãƒ€å¤‰æ›´</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">ã‚µãƒãƒªãƒ¼</div>
                    <div class="summary-cards">
                        <div class="summary-card progress">
                            <div class="value" id="totalProgress">0%</div>
                            <div class="label">å…¨ä½“é€²æ—</div>
                        </div>
                        <div class="summary-card">
                            <div class="value" id="totalItems">0</div>
                            <div class="label">WBSé …ç›®</div>
                        </div>
                        <div class="summary-card delayed">
                            <div class="value" id="delayedItems">0</div>
                            <div class="label">é…å»¶</div>
                        </div>
                        <div class="summary-card">
                            <div class="value" id="completedItems">0</div>
                            <div class="label">å®Œäº†</div>
                        </div>
                    </div>
                </div>

                <div class="view-tabs">
                    <button class="view-tab active" data-view="tree" onclick="window.app.switchView('tree')">ğŸ“‹
                        ãƒ„ãƒªãƒ¼</button>
                    <button class="view-tab" data-view="gantt" onclick="window.app.switchView('gantt')">ğŸ“Š ã‚¬ãƒ³ãƒˆ</button>
                </div>

                <div class="legend">
                    <div class="legend-title">å‡¡ä¾‹</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color deliverable"></div>
                            <span>æˆæœç‰©</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color support"></div>
                            <span>é‹ç”¨ãƒ»ã‚µãƒãƒ¼ãƒˆ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color buffer"></div>
                            <span>ãƒãƒƒãƒ•ã‚¡</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color milestone"></div>
                            <span>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</span>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="window.app.showAddWbsModal()">+ WBSè¿½åŠ </button>
                        <button class="btn btn-secondary" onclick="window.app.showAddWbsModal(null, 'support')">+
                            é‹ç”¨æ è¿½åŠ </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-secondary btn-small" onclick="window.app.expandAll()">å…¨å±•é–‹</button>
                        <button class="btn btn-secondary btn-small" onclick="window.app.collapseAll()">å…¨æŠ˜ç•³</button>
                    </div>
                </div>

                <!-- Tree View -->
                <div id="treeView" class="wbs-tree">
                    <div class="wbs-header">
                        <span>WBSå</span>
                        <span>æ‹…å½“è€…</span>
                        <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                        <span>æœŸé–“</span>
                        <span>é€²æ—</span>
                        <span>ä¾å­˜</span>
                        <span></span>
                    </div>
                    <div class="wbs-list" id="wbsList">
                        <div class="empty-state" id="emptyState">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div class="empty-state-title">WBSãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div class="empty-state-desc">ã€Œ+ WBSè¿½åŠ ã€ãƒœã‚¿ãƒ³ã§WBSã‚’ä½œæˆã—ã¦ãã ã•ã„</div>
                        </div>
                    </div>
                </div>

                <!-- Gantt View -->
                <div id="ganttView" class="gantt-container" style="display: none;">
                    <div id="ganttChart"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</div>
                <button class="modal-close" onclick="window.app.closeCategoryModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label required">ã‚«ãƒ†ã‚´ãƒªå</label>
                        <input type="text" id="catName" class="form-input" placeholder="ä¾‹: é–‹ç™º, ãƒ‡ã‚¶ã‚¤ãƒ³">
                    </div>
                    <div class="form-group" style="width: 100px;">
                        <label class="form-label">è‰²</label>
                        <input type="color" id="catColor" class="form-input" value="#1d9bf0" style="height: 42px;">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="window.app.saveCategory()">è¿½åŠ </button>
                    </div>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 20px 0;"></div>

                <div id="categoryList" class="wbs-list">
                    <!-- Categories will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.app.closeCategoryModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</div>
                <button class="modal-close" onclick="window.app.closeMemberModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label required">åå‰</label>
                        <input type="text" id="memName" class="form-input" placeholder="ä¾‹: å±±ç”°">
                    </div>
                    <div class="form-group" style="width: 120px;">
                        <label class="form-label">å½¹å‰²</label>
                        <input type="text" id="memRole" class="form-input" placeholder="ä¾‹: Dev">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="window.app.saveMember()">è¿½åŠ </button>
                    </div>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 20px 0;"></div>

                <div id="memberList" class="wbs-list">
                    <!-- Members will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.app.closeMemberModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Milestone Modal -->
    <div id="milestoneModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†</div>
                <button class="modal-close" onclick="window.app.closeMilestoneModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label required">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å</label>
                        <input type="text" id="milName" class="form-input" placeholder="ä¾‹: Î±ç‰ˆãƒªãƒªãƒ¼ã‚¹">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label required">æ—¥ä»˜</label>
                        <input type="date" id="milDate" class="form-input">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">èª¬æ˜</label>
                    <input type="text" id="milDesc" class="form-input" placeholder="ä»»æ„">
                </div>
                <div class="form-group" style="display: flex; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="window.app.saveMilestone()">è¿½åŠ </button>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 20px 0;"></div>

                <div id="milestoneList" class="wbs-list">
                    <!-- Milestones will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.app.closeMilestoneModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit WBS Modal -->
    <div class="modal-overlay" id="wbsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="wbsModalTitle">WBSè¿½åŠ </h2>
                <button class="modal-close" onclick="window.app.closeWbsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">WBSã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" id="wbsCode" class="form-input" placeholder="ä¾‹: 1.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">ç¨®åˆ¥</label>
                        <select id="wbsType" class="form-select">
                            <option value="deliverable">æˆæœç‰©</option>
                            <option value="support">é‹ç”¨ãƒ»ã‚µãƒãƒ¼ãƒˆ</option>
                            <option value="buffer">ãƒãƒƒãƒ•ã‚¡</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">åç§°</label>
                    <input type="text" id="wbsName" class="form-input" placeholder="ä¾‹: è¦ä»¶å®šç¾©">
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="wbsCategory" class="form-select">
                        <option value="">(é¸æŠãªã—)</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">è¦ªWBSã‚³ãƒ¼ãƒ‰</label>
                        <select id="wbsParent" class="form-select">
                            <option value="">ãªã—ï¼ˆæœ€ä¸Šä½ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‹…å½“è€…</label>
                        <select id="wbsAssignee" class="form-select">
                            <option value="">(æœªå®š)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">äºˆå®šé–‹å§‹æ—¥</label>
                        <input type="date" id="wbsStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">äºˆå®šçµ‚äº†æ—¥</label>
                        <input type="date" id="wbsEndDate" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">äºˆå®šå·¥æ•°ï¼ˆäººæ—¥ï¼‰</label>
                        <input type="number" id="wbsEffort" class="form-input" placeholder="ä¾‹: 5" min="0" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é€²æ—ï¼ˆ%ï¼‰</label>
                        <input type="number" id="wbsProgress" class="form-input" placeholder="0" min="0" max="100">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä¾å­˜é–¢ä¿‚ï¼ˆå…ˆè¡ŒWBSï¼‰</label>
                    <select id="wbsDependencies" class="form-select" multiple style="height: 80px;">
                    </select>
                    <small style="color: var(--text-secondary); font-size: 11px;">Ctrl+ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</small>
                </div>

                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="wbsMilestone">
                        <span>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¨ã—ã¦è¡¨ç¤º</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">ãƒ¡ãƒ¢</label>
                    <textarea id="wbsNote" class="form-textarea" placeholder="å‚™è€ƒã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.app.closeWbsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="window.app.saveWbs()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h2>
                <button class="modal-close" onclick="window.app.closeProjectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID</label>
                    <input type="text" id="projectId" class="form-input" placeholder="ä¾‹: project_2024">
                    <small style="color: var(--text-secondary); font-size: 11px;">è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿</small>
                </div>
                <div class="form-group">
                    <label class="form-label required">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                    <input type="text" id="projectName" class="form-input" placeholder="ä¾‹: æ–°è¦ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º">
                </div>
                <div class="form-group">
                    <label class="form-label">èª¬æ˜</label>
                    <textarea id="projectDesc" class="form-textarea" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.app.closeProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="window.app.createProject()">ä½œæˆ</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="window.app.contextMenuAction('edit')">âœï¸ ç·¨é›†</div>
        <div class="context-menu-item" onclick="window.app.contextMenuAction('addChild')">â• å­WBSè¿½åŠ </div>
        <div class="context-menu-item" onclick="window.app.contextMenuAction('duplicate')">ğŸ“‹ è¤‡è£½</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="window.app.contextMenuAction('delete')">ğŸ—‘ï¸ å‰Šé™¤</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>

/* --- js/state.js --- */
const state = {
    directoryHandle: null,
    currentProject: null,
    projects: [],
    wbsItems: [],
    categories: [],
    members: [],
    milestones: [],
    expandedNodes: new Set(),
    editingWbsId: null,
    contextMenuTarget: null,
    currentView: 'tree',
    autoReloadInterval: null
};

function updateState(newState) {
    Object.assign(state, newState);
}


/* --- js/utils/dom.js --- */
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/[&<>"']/g, char => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[char]));
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  if (!container) return;
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}


/* --- js/utils/date.js --- */
function formatDateRange(start, end) {
    if (!start && !end) return '-';
    const formatDate = d => d ? new Date(d).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' }) : '';
    return `${formatDate(start)} - ${formatDate(end)}`;
}


/* --- js/storage.js --- */



async function selectProjectFolder() {
    try {
        const handle = await window.showDirectoryPicker({
            mode: 'readwrite'
        });
        updateState({ directoryHandle: handle });
        return handle;
    } catch (err) {
        if (err.name !== 'AbortError') {
            console.error(err);
            showToast('ãƒ•ã‚©ãƒ«ãƒ€ã®é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
        throw err;
    }
}

async function loadProjects() {
    const projects = [];
    try {
        for await (const entry of state.directoryHandle.values()) {
            if (entry.kind === 'directory') {
                try {
                    const projectDir = await state.directoryHandle.getDirectoryHandle(entry.name);
                    const projectFile = await projectDir.getFileHandle('project.json');
                    const file = await projectFile.getFile();
                    const content = await file.text();
                    const project = JSON.parse(content);
                    projects.push(project);
                } catch (e) {
                    // project.jsonãŒãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
                }
            }
        }
        updateState({ projects });
        return projects;
    } catch (err) {
        console.error('Load projects error:', err);
        throw err;
    }
}


async function loadMasterData() {
    if (!state.currentProject) return;

    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(state.currentProject.id);

        // Load Categories
        try {
            const file = await projectDir.getFileHandle('categories.json');
            const content = await (await file.getFile()).text();
            updateState({ categories: JSON.parse(content) });
        } catch (e) {
            updateState({ categories: [] });
        }

        // Load Members
        try {
            const file = await projectDir.getFileHandle('members.json');
            const content = await (await file.getFile()).text();
            updateState({ members: JSON.parse(content) });
        } catch (e) {
            updateState({ members: [] });
        }

        // Load Milestones
        try {
            const file = await projectDir.getFileHandle('milestones.json');
            const content = await (await file.getFile()).text();
            updateState({ milestones: JSON.parse(content) });
        } catch (e) {
            updateState({ milestones: [] });
        }

    } catch (err) {
        console.error('Load Master Data error:', err);
        // showToast('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); // Optional: quiet fail if files don't exist yet
    }
}

async function saveCategories(categories) {
    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(state.currentProject.id);
        const fileHandle = await projectDir.getFileHandle('categories.json', { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(categories, null, 2));
        await writable.close();
        updateState({ categories });
    } catch (err) {
        console.error('Save Categories error:', err);
        showToast('ã‚«ãƒ†ã‚´ãƒªã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw err;
    }
}

async function saveMembers(members) {
    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(state.currentProject.id);
        const fileHandle = await projectDir.getFileHandle('members.json', { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(members, null, 2));
        await writable.close();
        updateState({ members });
    } catch (err) {
        console.error('Save Members error:', err);
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw err;
    }
}

async function saveMilestones(milestones) {
    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(state.currentProject.id);
        const fileHandle = await projectDir.getFileHandle('milestones.json', { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(milestones, null, 2));
        await writable.close();
        updateState({ milestones });
    } catch (err) {
        console.error('Save Milestones error:', err);
        showToast('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw err;
    }
}

async function loadWbsItems() {
    if (!state.currentProject) return [];

    // Load Master Data as well
    await loadMasterData();

    const wbsItems = [];

    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(state.currentProject.id);
        const wbsDir = await projectDir.getDirectoryHandle('wbs');

        for await (const entry of wbsDir.values()) {
            if (entry.kind === 'file' && entry.name.endsWith('.json')) {
                const file = await entry.getFile();
                const content = await file.text();
                const wbs = JSON.parse(content);
                wbsItems.push(wbs);
            }
        }

        // ã‚³ãƒ¼ãƒ‰ã§ã‚½ãƒ¼ãƒˆ
        wbsItems.sort((a, b) => compareWbsCode(a.code, b.code));
        updateState({ wbsItems });
        return wbsItems;
    } catch (err) {
        console.error('Load WBS error:', err);
        showToast('WBSã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw err;
    }
}

function compareWbsCode(a, b) {
    const partsA = a.split('.').map(Number);
    const partsB = b.split('.').map(Number);

    for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
        const numA = partsA[i] || 0;
        const numB = partsB[i] || 0;
        if (numA !== numB) return numA - numB;
    }
    return 0;
}

async function saveWbs(wbs) {
    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(state.currentProject.id);
        const wbsDir = await projectDir.getDirectoryHandle('wbs');
        const fileName = `${wbs.id}.json`;
        const fileHandle = await wbsDir.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(wbs, null, 2));
        await writable.close();
        showToast(wbs.id.startsWith('wbs_') ? 'WBSã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'WBSã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    } catch (err) {
        console.error('Save WBS error:', err);
        showToast('WBSã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw err;
    }
}

async function deleteWbs(wbsId) {
    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(state.currentProject.id);
        const wbsDir = await projectDir.getDirectoryHandle('wbs');
        await wbsDir.removeEntry(`${wbsId}.json`);
        showToast('WBSã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    } catch (err) {
        console.error('Delete WBS error:', err);
        showToast('WBSã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        throw err;
    }
}

async function createProject(project) {
    try {
        const projectDir = await state.directoryHandle.getDirectoryHandle(project.id, { create: true });
        await projectDir.getDirectoryHandle('wbs', { create: true });

        const projectFile = await projectDir.getFileHandle('project.json', { create: true });
        const writable = await projectFile.createWritable();
        await writable.write(JSON.stringify(project, null, 2));
        await writable.close();
        return project;
    } catch (err) {
        console.error('Create project error:', err);
        throw err;
    }
}


/* --- js/ui/tree.js --- */




function renderWbsTree() {
    const container = document.getElementById('wbsList');
    const emptyState = document.getElementById('emptyState');

    if (state.wbsItems.length === 0) {
        container.innerHTML = '';
        if (emptyState) {
            container.appendChild(emptyState);
            emptyState.style.display = 'block';
        }
        return;
    }

    if (emptyState) emptyState.style.display = 'none';

    const tree = buildTree();
    container.innerHTML = renderTreeNodes(tree);
}

function buildTree() {
    const map = new Map();
    const roots = [];

    state.wbsItems.forEach(w => {
        map.set(w.code, { ...w, children: [] });
    });

    state.wbsItems.forEach(w => {
        const node = map.get(w.code);
        if (w.parentCode && map.has(w.parentCode)) {
            map.get(w.parentCode).children.push(node);
        } else {
            roots.push(node);
        }
    });

    return roots;
}

function renderTreeNodes(nodes, level = 0) {
    let html = '';

    nodes.forEach(node => {
        const hasChildren = node.children && node.children.length > 0;
        const isExpanded = state.expandedNodes.has(node.code);
        const isOverdue = node.plannedEnd && new Date(node.plannedEnd) < new Date() && node.status !== 'completed';

        html += `
      <div class="wbs-item level-${level}" data-id="${node.id}" data-code="${node.code}"
           oncontextmenu="window.app.showContextMenu(event, '${node.id}')">
        <div class="wbs-name">
          ${hasChildren ? `
            <span class="wbs-toggle" onclick="window.app.toggleNode('${node.code}')">
              ${isExpanded ? 'â–¼' : 'â–¶'}
            </span>
          ` : '<span style="width: 20px;"></span>'}
          <span class="wbs-type-badge ${node.type}"></span>
          <span class="wbs-code">${node.code}</span>
          <span class="wbs-title" onclick="window.app.showEditWbsModal('${node.id}')">
            ${node.milestone ? '<span class="milestone-icon">â—†</span>' : ''}
            ${escapeHtml(node.name)}
          </span>
        </div>
        <div class="wbs-assignee">${escapeHtml(node.assignee || '-')}</div>
        <div class="wbs-status ${node.status}">${getStatusLabel(node.status)}</div>
        <div class="wbs-dates ${isOverdue ? 'overdue' : ''}">
          ${formatDateRange(node.plannedStart, node.plannedEnd)}
        </div>
        <div class="progress-cell">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${node.progress}%"></div>
          </div>
          <span class="progress-text">${node.progress}%</span>
        </div>
        <div class="wbs-deps">
          ${node.dependencies?.map(d => `<span class="dep-badge">â†’${d}</span>`).join('') || '-'}
        </div>
        <div class="wbs-actions">
          <button class="btn-icon btn-small" onclick="window.app.showEditWbsModal('${node.id}')" title="ç·¨é›†">âœï¸</button>
          <button class="btn-icon btn-small" onclick="window.app.deleteWbs('${node.id}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;

        if (hasChildren && isExpanded) {
            html += renderTreeNodes(node.children, level + 1);
        }
    });

    return html;
}

function getStatusLabel(status) {
    const labels = {
        'not-started': 'æœªç€æ‰‹',
        'in-progress': 'é€²è¡Œä¸­',
        'completed': 'å®Œäº†',
        'on-hold': 'ä¿ç•™'
    };
    return labels[status] || status;
}


/* --- js/ui/gantt.js --- */



function renderGanttChart() {
  const container = document.getElementById('ganttChart');
  if (!container) return;

  if (state.wbsItems.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-title">WBSãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }

  // æ—¥ä»˜ç¯„å›²ã‚’è¨ˆç®—
  const wbsDates = state.wbsItems
    .filter(w => w.plannedStart || w.plannedEnd)
    .flatMap(w => [w.plannedStart, w.plannedEnd].filter(Boolean));

  const milestoneDates = state.milestones.map(m => m.date);
  const dates = [...wbsDates, ...milestoneDates].map(d => new Date(d));

  if (dates.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><div class="empty-state-title">æ—¥ä»˜ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>';
    return;
  }

  const minDate = new Date(Math.min(...dates));
  const maxDate = new Date(Math.max(...dates));

  // å‰å¾Œã«ä½™è£•ã‚’æŒãŸã›ã‚‹
  minDate.setDate(minDate.getDate() - 7);
  maxDate.setDate(maxDate.getDate() + 7);

  const dayCount = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
  const dayWidth = 40;
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ—¥ä»˜ï¼‰
  let datesHtml = '';
  for (let i = 0; i < dayCount; i++) {
    const date = new Date(minDate);
    date.setDate(date.getDate() + i);
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const isToday = date.getTime() === today.getTime();

    datesHtml += `
      <div class="gantt-date ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
        ${date.getDate()}
      </div>
    `;
  }

  // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤ºã®ç”Ÿæˆ
  let milestonesHtml = '';
  if (state.milestones) {
    state.milestones.forEach(mil => {
      const milDate = new Date(mil.date);
      if (milDate >= minDate && milDate <= maxDate) {
        const offset = Math.floor((milDate - minDate) / (1000 * 60 * 60 * 24));
        milestonesHtml += `
                <div class="gantt-milestone-marker" 
                     style="left: ${offset * dayWidth + dayWidth / 2 - 6}px; top: 2px;"
                     title="${mil.name}: ${mil.description || ''}">
                </div>
            `;
      }
    });
  }

  // è¡Œï¼ˆWBSã”ã¨ï¼‰
  let labelsHtml = '';
  let barsHtml = '';

  state.wbsItems.forEach(w => {
    const indent = 'ã€€'.repeat(w.level || 0);
    labelsHtml += `
      <div class="gantt-row-label">
        <span class="wbs-type-badge ${w.type}" style="width: 3px; height: 16px;"></span>
        <span>${indent}${w.code} ${escapeHtml(w.name)}</span>
      </div>
    `;

    let barHtml = '';
    if (w.plannedStart && w.plannedEnd) {
      const start = new Date(w.plannedStart);
      const end = new Date(w.plannedEnd);
      const startOffset = Math.floor((start - minDate) / (1000 * 60 * 60 * 24));
      const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

      if (w.milestone) {
        barHtml = `<div class="gantt-milestone" style="left: ${startOffset * dayWidth + dayWidth / 2 - 8}px;"></div>`;
      } else {
        barHtml = `
          <div class="gantt-bar ${w.type}" style="left: ${startOffset * dayWidth}px; width: ${duration * dayWidth - 4}px;">
            <div class="progress-overlay" style="width: ${w.progress}%;"></div>
            <span style="position: relative; z-index: 1;">${w.progress}%</span>
          </div>
        `;
      }
    }

    barsHtml += `<div class="gantt-row">${barHtml}</div>`;
  });

  container.innerHTML = `
    <div class="gantt-header">
      <div class="gantt-labels" style="padding: 8px 12px; font-size: 11px; color: var(--text-secondary);">
        WBS
      </div>
      <div class="gantt-timeline">
        <div class="gantt-dates" style="width: ${dayCount * dayWidth}px;">
          ${datesHtml}
          ${milestonesHtml}
        </div>
      </div>
    </div>
    <div class="gantt-rows">
      <div class="gantt-row-labels">
        ${labelsHtml}
      </div>
      <div class="gantt-row-bars" style="overflow-x: auto;">
        <div style="width: ${dayCount * dayWidth}px;">
          ${barsHtml}
        </div>
      </div>
    </div>
  `;
}


/* --- js/ui/modals.js --- */






function showNewProjectModal() {
    document.getElementById('projectId').value = '';
    document.getElementById('projectName').value = '';
    document.getElementById('projectDesc').value = '';
    document.getElementById('projectModal').classList.add('show');
}

function closeProjectModal() {
    document.getElementById('projectModal').classList.remove('show');
}

function showAddWbsModal(parentCode = null, defaultType = 'deliverable') {
    updateState({ editingWbsId: null });
    document.getElementById('wbsModalTitle').textContent = 'WBSè¿½åŠ ';

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('wbsCode').value = parentCode ? window.app.getNextChildCode(parentCode) : window.app.getNextTopCode();
    document.getElementById('wbsType').value = defaultType;
    document.getElementById('wbsName').value = '';
    document.getElementById('wbsCategory').value = '';
    document.getElementById('wbsAssignee').value = '';
    document.getElementById('wbsStartDate').value = '';
    document.getElementById('wbsEndDate').value = '';
    document.getElementById('wbsEffort').value = '';
    document.getElementById('wbsProgress').value = '0';
    document.getElementById('wbsMilestone').checked = false;
    document.getElementById('wbsNote').value = '';

    window.app.updateParentSelect(parentCode);
    window.app.updateDependenciesSelect();
    window.app.updateCategorySelect();
    window.app.updateMemberSelect();

    document.getElementById('wbsModal').classList.add('show');
}

function showEditWbsModal(wbsId) {
    const wbs = state.wbsItems.find(w => w.id === wbsId);
    if (!wbs) return;

    updateState({ editingWbsId: wbsId });
    document.getElementById('wbsModalTitle').textContent = 'WBSç·¨é›†';

    document.getElementById('wbsCode').value = wbs.code;
    document.getElementById('wbsType').value = wbs.type;
    document.getElementById('wbsName').value = wbs.name;
    document.getElementById('wbsCategory').value = wbs.categoryId || '';
    // Assignee is handled by updateMemberSelect to include non-registered members

    document.getElementById('wbsStartDate').value = wbs.plannedStart || '';
    document.getElementById('wbsEndDate').value = wbs.plannedEnd || '';
    document.getElementById('wbsEffort').value = wbs.plannedEffort || '';
    document.getElementById('wbsProgress').value = wbs.progress || 0;
    document.getElementById('wbsMilestone').checked = wbs.milestone || false;
    document.getElementById('wbsNote').value = wbs.note || '';

    window.app.updateParentSelect(wbs.parentCode);
    window.app.updateDependenciesSelect(wbs.dependencies);
    window.app.updateDependenciesSelect(wbs.dependencies);
    window.app.updateCategorySelect(wbs.categoryId);
    window.app.updateMemberSelect(wbs.assignee);

    document.getElementById('wbsModal').classList.add('show');
}

function closeWbsModal() {
    document.getElementById('wbsModal').classList.remove('show');
    updateState({ editingWbsId: null });
}

// Category Management
function showCategoryModal() {
    renderCategoryList();
    document.getElementById('catName').value = '';
    document.getElementById('catColor').value = '#1d9bf0';
    document.getElementById('categoryModal').classList.add('show');
}

function closeCategoryModal() {
    document.getElementById('categoryModal').classList.remove('show');
}

async function saveCategory() {
    const name = document.getElementById('catName').value.trim();
    const color = document.getElementById('catColor').value;

    if (!name) {
        showToast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }

    const newCategory = {
        id: `cat_${Date.now()}`,
        name,
        color
    };

    const categories = [...state.categories, newCategory];
    await saveCategories(categories);

    document.getElementById('catName').value = '';
    renderCategoryList();
    showToast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteCategory(id) {
    if (!confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    const categories = state.categories.filter(c => c.id !== id);
    await saveCategories(categories);
    renderCategoryList();
    showToast('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

function renderCategoryList() {
    const list = document.getElementById('categoryList');
    list.innerHTML = '';

    if (state.categories.length === 0) {
        list.innerHTML = '<div class="empty-state-desc">ã‚«ãƒ†ã‚´ãƒªãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
    }

    state.categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'wbs-item';
        div.style.gridTemplateColumns = 'auto 100px';
        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 16px; height: 16px; border-radius: 4px; background: ${cat.color};"></div>
                <span>${cat.name}</span>
            </div>
            <button class="btn btn-icon btn-small" style="color: var(--accent-red);" onclick="window.app.deleteCategory('${cat.id}')">å‰Šé™¤</button>
        `;
        list.appendChild(div);
    });
}

// Milestone Management
function showMilestoneModal() {
    renderMilestoneList();
    document.getElementById('milName').value = '';
    document.getElementById('milDate').value = '';
    document.getElementById('milDesc').value = '';
    document.getElementById('milestoneModal').classList.add('show');
}

function closeMilestoneModal() {
    document.getElementById('milestoneModal').classList.remove('show');
}

async function saveMilestone() {
    const name = document.getElementById('milName').value.trim();
    const date = document.getElementById('milDate').value;
    const description = document.getElementById('milDesc').value.trim();

    if (!name || !date) {
        showToast('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³åã¨æ—¥ä»˜ã¯å¿…é ˆã§ã™', 'error');
        return;
    }

    const newMilestone = {
        id: `mil_${Date.now()}`,
        name,
        date,
        description
    };

    const milestones = [...state.milestones, newMilestone];
    await saveMilestones(milestones);

    document.getElementById('milName').value = '';
    document.getElementById('milDate').value = '';
    document.getElementById('milDesc').value = '';
    renderMilestoneList();
    showToast('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteMilestone(id) {
    if (!confirm('ã“ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    const milestones = state.milestones.filter(m => m.id !== id);
    await saveMilestones(milestones);
    renderMilestoneList();
    showToast('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

function renderMilestoneList() {
    const list = document.getElementById('milestoneList');
    list.innerHTML = '';

    if (state.milestones.length === 0) {
        list.innerHTML = '<div class="empty-state-desc">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
    }

    state.milestones.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(mil => {
        const div = document.createElement('div');
        div.className = 'wbs-item';
        div.style.gridTemplateColumns = '120px auto 100px';
        div.innerHTML = `
            <div>${mil.date}</div>
            <div>
                <span style="font-weight: bold;">${mil.name}</span>
                <div style="font-size: 12px; color: var(--text-secondary);">${mil.description || ''}</div>
            </div>
            <button class="btn btn-icon btn-small" style="color: var(--accent-red);" onclick="window.app.deleteMilestone('${mil.id}')">å‰Šé™¤</button>
        `;
        list.appendChild(div);
    });
}

// Member Management
function showMemberModal() {
    renderMemberList();
    document.getElementById('memName').value = '';
    document.getElementById('memRole').value = '';
    document.getElementById('memberModal').classList.add('show');
}

function closeMemberModal() {
    document.getElementById('memberModal').classList.remove('show');
}

async function saveMember() {
    const name = document.getElementById('memName').value.trim();
    const role = document.getElementById('memRole').value.trim();

    if (!name) {
        showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }

    const newMember = {
        id: `mem_${Date.now()}`,
        name,
        role
    };

    const members = [...state.members, newMember];
    await saveMembers(members);

    document.getElementById('memName').value = '';
    document.getElementById('memRole').value = '';
    renderMemberList();
    showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteMember(id) {
    if (!confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    const members = state.members.filter(m => m.id !== id);
    await saveMembers(members);
    renderMemberList();
    showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

function renderMemberList() {
    const list = document.getElementById('memberList');
    list.innerHTML = '';

    if (state.members.length === 0) {
        list.innerHTML = '<div class="empty-state-desc">ãƒ¡ãƒ³ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
    }

    state.members.forEach(mem => {
        const div = document.createElement('div');
        div.className = 'wbs-item';
        div.style.gridTemplateColumns = 'auto 100px 100px';
        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span>${mem.name}</span>
            </div>
            <div style="color: var(--text-secondary); font-size: 13px;">${mem.role || '-'}</div>
            <button class="btn btn-icon btn-small" style="color: var(--accent-red);" onclick="window.app.deleteMember('${mem.id}')">å‰Šé™¤</button>
        `;
        list.appendChild(div);
    });
}


/* --- main.js --- */







// Imports are removed by build.js, so we rely on global functions defined in previous files.
// selectProjectFolder is defined in js/storage.js

// Global Exposure for HTML Event Handlers
window.app = {
    selectProjectFolder: async () => {
        console.log('Starting selectProjectFolder...');
        try {
            // function selectProjectFolder() is global from storage.js
            await selectProjectFolder();
            console.log('Folder selected successfully.');

            const userName = document.getElementById('setupUserName').value.trim() ||
                document.getElementById('userName').value.trim();

            if (!userName) {
                console.log('Username is empty.');
                showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            console.log('Setting up user:', userName);
            localStorage.setItem('wbs_userName', userName);
            document.getElementById('userName').value = userName;

            console.log('Switching to main app view...');
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            updateConnectionStatus(true);

            console.log('Loading projects list...');
            await loadProjectsList();
            startAutoReload();
            showToast('ãƒ•ã‚©ãƒ«ãƒ€ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
        } catch (err) {
            if (err.name === 'AbortError') {
                console.log('Folder selection cancelled by user.');
                return;
            }
            console.error('Setup error:', err);
            showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message, 'error');
        }
    },
    switchProject,
    showNewProjectModal,
    closeProjectModal,
    createProject: handleCreateProject,
    reloadData,
    saveUserName,
    switchView,
    expandAll,
    collapseAll,
    showAddWbsModal,
    showEditWbsModal,
    closeWbsModal,
    saveWbs: handleSaveWbs,
    deleteWbs: handleDeleteWbs,
    toggleNode,
    showContextMenu,
    contextMenuAction,
    // Helper for modals
    getNextTopCode,
    getNextChildCode,
    updateParentSelect,
    updateDependenciesSelect,
    updateCategorySelect,
    // Category Modal
    showCategoryModal,
    closeCategoryModal,
    saveCategory,
    saveCategory,
    deleteCategory,
    // Member Modal
    showMemberModal,
    closeMemberModal,
    saveMember,
    deleteMember,
    updateMemberSelect,
    // Milestone Modal
    showMilestoneModal,
    closeMilestoneModal,
    saveMilestone,
    deleteMilestone
};

async function loadProjectsList() {
    await loadProjects();
    const select = document.getElementById('projectSelect');
    select.innerHTML = '<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</option>';
    state.projects.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.name;
        select.appendChild(option);
    });

    const lastProject = localStorage.getItem('wbs_lastProject');
    if (lastProject && state.projects.find(p => p.id === lastProject)) {
        select.value = lastProject;
        await switchProject();
    }
}

async function switchProject() {
    const select = document.getElementById('projectSelect');
    const projectId = select.value;

    if (!projectId) {
        updateState({ currentProject: null, wbsItems: [] });
        renderWbsTree();
        return;
    }

    const currentProject = state.projects.find(p => p.id === projectId);
    updateState({ currentProject });
    localStorage.setItem('wbs_lastProject', projectId);

    await loadWbsItems();
    updateSummary();
    renderWbsTree();
}

async function handleCreateProject() {
    const id = document.getElementById('projectId').value.trim();
    const name = document.getElementById('projectName').value.trim();
    const desc = document.getElementById('projectDesc').value.trim();

    if (!id || !name) {
        showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¨åå‰ã¯å¿…é ˆã§ã™', 'error');
        return;
    }

    const project = {
        id,
        name,
        description: desc,
        createdAt: new Date().toISOString(),
        createdBy: document.getElementById('userName').value.trim()
    };

    await createProject(project);
    closeProjectModal();
    await loadProjectsList();
    document.getElementById('projectSelect').value = id;
    await switchProject();
    showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
}

async function handleSaveWbs() {
    const code = document.getElementById('wbsCode').value.trim();
    const name = document.getElementById('wbsName').value.trim();
    const categoryId = document.getElementById('wbsCategory').value;
    const type = document.getElementById('wbsType').value;
    const parentCode = document.getElementById('wbsParent').value;
    const assignee = document.getElementById('wbsAssignee').value.trim();
    const startDate = document.getElementById('wbsStartDate').value;
    const endDate = document.getElementById('wbsEndDate').value;
    const effort = parseFloat(document.getElementById('wbsEffort').value) || 0;
    const progress = parseInt(document.getElementById('wbsProgress').value) || 0;
    const milestone = document.getElementById('wbsMilestone').checked;
    const note = document.getElementById('wbsNote').value.trim();

    const depsSelect = document.getElementById('wbsDependencies');
    const dependencies = Array.from(depsSelect.selectedOptions).map(o => o.value);

    if (!code || !name) {
        showToast('WBSã‚³ãƒ¼ãƒ‰ã¨åç§°ã¯å¿…é ˆã§ã™', 'error');
        return;
    }

    const wbs = {
        id: state.editingWbsId || ('wbs_' + Date.now()),
        code,
        name,
        categoryId,
        type,
        parentCode: parentCode || null,
        level: parentCode ? parentCode.split('.').length : 0,
        assignee,
        plannedStart: startDate || null,
        plannedEnd: endDate || null,
        plannedEffort: effort,
        actualEffort: 0,
        progress,
        progressCalcMethod: 'manual',
        milestone,
        dependencies,
        status: progress === 100 ? 'completed' : progress > 0 ? 'in-progress' : 'not-started',
        note,
        createdAt: state.editingWbsId ? state.wbsItems.find(w => w.id === state.editingWbsId)?.createdAt : new Date().toISOString(),
        createdBy: state.editingWbsId ? state.wbsItems.find(w => w.id === state.editingWbsId)?.createdBy : document.getElementById('userName').value.trim(),
        updatedAt: new Date().toISOString(),
        updatedBy: document.getElementById('userName').value.trim()
    };

    await saveWbs(wbs);
    closeWbsModal();
    await loadWbsItems();
    updateSummary();
    renderWbsTree();
}

async function handleDeleteWbs(wbsId) {
    if (!confirm('ã“ã®WBSã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    await deleteWbs(wbsId);
    await loadWbsItems();
    updateSummary();
    renderWbsTree();
}

// UI Helpers
function toggleNode(code) {
    if (state.expandedNodes.has(code)) {
        state.expandedNodes.delete(code);
    } else {
        state.expandedNodes.add(code);
    }
    renderWbsTree();
}

function expandAll() {
    state.wbsItems.forEach(w => state.expandedNodes.add(w.code));
    renderWbsTree();
}

function collapseAll() {
    state.expandedNodes.clear();
    renderWbsTree();
}

function switchView(view) {
    updateState({ currentView: view });
    document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === view);
    });
    document.getElementById('treeView').style.display = view === 'tree' ? 'block' : 'none';
    document.getElementById('ganttView').style.display = view === 'gantt' ? 'block' : 'none';
    if (view === 'gantt') renderGanttChart();
}

function updateSummary() {
    const total = state.wbsItems.length;
    const completed = state.wbsItems.filter(w => w.status === 'completed').length;
    const delayed = state.wbsItems.filter(w => {
        return w.plannedEnd && new Date(w.plannedEnd) < new Date() && w.status !== 'completed';
    }).length;

    const totalEffort = state.wbsItems.reduce((sum, w) => sum + (w.plannedEffort || 1), 0);
    const weightedProgress = state.wbsItems.reduce((sum, w) => {
        return sum + (w.plannedEffort || 1) * (w.progress || 0);
    }, 0);
    const avgProgress = totalEffort > 0 ? Math.round(weightedProgress / totalEffort) : 0;

    document.getElementById('totalProgress').textContent = `${avgProgress}% `;
    document.getElementById('totalItems').textContent = total;
    document.getElementById('delayedItems').textContent = delayed;
    document.getElementById('completedItems').textContent = completed;
}

function updateConnectionStatus(connected) {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    if (dot) dot.classList.toggle('connected', connected);
    if (text) text.textContent = connected ? 'æ¥ç¶šä¸­' : 'æœªæ¥ç¶š';
}

function startAutoReload() {
    if (state.autoReloadInterval) clearInterval(state.autoReloadInterval);
    updateState({ autoReloadInterval: setInterval(reloadData, 60000) });
}

async function reloadData() {
    if (!state.directoryHandle || !state.currentProject) return;
    await loadWbsItems();
    updateSummary();
    renderWbsTree();
    showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
}

function saveUserName() {
    const userName = document.getElementById('userName').value.trim();
    if (userName) localStorage.setItem('wbs_userName', userName);
}

// Modal Helpers
function getNextTopCode() {
    const topItems = state.wbsItems.filter(w => !w.parentCode);
    if (topItems.length === 0) return '1';
    const maxCode = Math.max(...topItems.map(w => parseInt(w.code.split('.')[0])));
    return String(maxCode + 1);
}

function getNextChildCode(parentCode) {
    const children = state.wbsItems.filter(w => w.parentCode === parentCode);
    if (children.length === 0) return `${parentCode} .1`;
    const maxChild = Math.max(...children.map(w => {
        const parts = w.code.split('.');
        return parseInt(parts[parts.length - 1]);
    }));
    return `${parentCode}.${maxChild + 1} `;
}

function updateParentSelect(selectedCode = null) {
    const select = document.getElementById('wbsParent');
    if (!select) return;
    select.innerHTML = '<option value="">ãªã—ï¼ˆæœ€ä¸Šä½ï¼‰</option>';
    state.wbsItems.forEach(w => {
        if (state.editingWbsId && (w.id === state.editingWbsId || isDescendant(w.code, state.wbsItems.find(item => item.id === state.editingWbsId)?.code))) return;
        const option = document.createElement('option');
        option.value = w.code;
        option.textContent = `${w.code} ${w.name} `;
        if (w.code === selectedCode) option.selected = true;
        select.appendChild(option);
    });
}

function updateDependenciesSelect(selectedDeps = []) {
    const select = document.getElementById('wbsDependencies');
    if (!select) return;
    select.innerHTML = '';
    state.wbsItems.forEach(w => {
        if (state.editingWbsId && w.id === state.editingWbsId) return;
        const option = document.createElement('option');
        option.value = w.code;
        option.textContent = `${w.code} ${w.name} `;
        if (selectedDeps.includes(w.code)) option.selected = true;
        select.appendChild(option);
    });
}

function isDescendant(childCode, parentCode) {
    if (!parentCode) return false;
    return childCode.startsWith(parentCode + '.');
}

function updateCategorySelect(selectedCategoryId = null) {
    const select = document.getElementById('wbsCategory');
    if (!select) return;
    select.innerHTML = '<option value="">(é¸æŠãªã—)</option>';
    state.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        option.style.borderLeft = `4px solid ${cat.color} `;
        if (cat.id === selectedCategoryId) option.selected = true;
        select.appendChild(option);
    });
}

function updateMemberSelect(selectedAssignee = null) {
    const select = document.getElementById('wbsAssignee');
    if (!select) return;
    select.innerHTML = '<option value="">(æœªå®š)</option>';

    // ç™»éŒ²æ¸ˆã¿ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ 
    state.members.forEach(mem => {
        const option = document.createElement('option');
        option.value = mem.name; // ã“ã“ã§ã¯åå‰ã‚’Valueã¨ã™ã‚‹ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
        // å°†æ¥çš„ã«ã¯IDã«ã™ã‚‹ã¹ãã ãŒã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒåå‰ã§å…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ã¾ãšã¯åå‰ã§ãƒãƒƒãƒãƒ³ã‚°ã•ã›ã‚‹

        option.textContent = mem.name + (mem.role ? ` (${mem.role})` : '');
        if (mem.name === selectedAssignee) option.selected = true;
        select.appendChild(option);
    });

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚‹ãŒãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã«ãªã„å ´åˆï¼ˆè‡ªç”±å…¥åŠ›ã•ã‚ŒãŸéå»ãƒ‡ãƒ¼ã‚¿ãªã©ï¼‰ã€ä¸€æ™‚çš„ã«è¿½åŠ 
    if (selectedAssignee && !state.members.find(m => m.name === selectedAssignee)) {
        const option = document.createElement('option');
        option.value = selectedAssignee;
        option.textContent = selectedAssignee + ' (æœªç™»éŒ²)';
        option.selected = true;
        select.appendChild(option);
    }
}

// Context Menu
function showContextMenu(event, wbsId) {
    event.preventDefault();
    updateState({ contextMenuTarget: wbsId });
    const menu = document.getElementById('contextMenu');
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    menu.classList.add('show');
}

function contextMenuAction(action) {
    if (!state.contextMenuTarget) return;
    const wbs = state.wbsItems.find(w => w.id === state.contextMenuTarget);
    switch (action) {
        case 'edit': showEditWbsModal(state.contextMenuTarget); break;
        case 'addChild': showAddWbsModal(wbs?.code); break;
        case 'duplicate': duplicateWbs(state.contextMenuTarget); break;
        case 'delete': handleDeleteWbs(state.contextMenuTarget); break;
    }
    document.getElementById('contextMenu').classList.remove('show');
    updateState({ contextMenuTarget: null });
}

async function duplicateWbs(wbsId) {
    const original = state.wbsItems.find(w => w.id === wbsId);
    if (!original) return;
    const newCode = original.parentCode ? getNextChildCode(original.parentCode) : getNextTopCode();
    const now = new Date().toISOString();
    const userName = document.getElementById('userName').value.trim();
    const newWbs = {
        ...original,
        id: `wbs_${Date.now()} `,
        code: newCode,
        name: `${original.name} (ã‚³ãƒ”ãƒ¼)`,
        progress: 0,
        status: 'not-started',
        createdAt: now,
        createdBy: userName,
        updatedAt: now,
        updatedBy: userName
    };
    await saveWbs(newWbs);
    await loadWbsItems();
    updateSummary();
    renderWbsTree();
}

// Initialization
document.addEventListener('DOMContentLoaded', () => {
    const savedUserName = localStorage.getItem('wbs_userName');
    if (savedUserName) {
        const setupUser = document.getElementById('setupUserName');
        const mainUser = document.getElementById('userName');
        if (setupUser) setupUser.value = savedUserName;
        if (mainUser) mainUser.value = savedUserName;
    }
    document.addEventListener('click', () => {
        const menu = document.getElementById('contextMenu');
        if (menu) menu.classList.remove('show');
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeWbsModal();
            closeProjectModal();
        }
    });
});


</script>
</body>

</html>